#!/bin/sh

PW_FLAG=/tmp/i_dont_give_a_fuck

cleanup() {
 [[ -f "$PW_FLAG" ]] || return 0
 rm -f "$PW_FLAG"
 return 0
}

grep -e Charging -e Full\
  /sys/class/power_supply/BAT0/status >/dev/null && \
 cleanup && exit

PW_LEFT=`cat /sys/class/power_supply/BAT0/charge_now`
PW=`cat /sys/class/power_supply/BAT0/charge_full`
PW=`echo -e "scale=2\n" "$PW_LEFT" / "$PW" | bc`
PW=${PW#*.}
PW=${PW#0}

if [[ $PW -lt 12 ]]; then aplay -q ~/media/appz/batt_down.wav
else if [[ $PW -lt 17 ]]; then aplay -q ~/media/appz/batt_warn.wav
 else if [[ $PW -lt 25 ]]; then aplay -q ~/media/appz/batt_low.wav
  else if [[ -O "$PW_FLAG" ]]; then cleanup && exit; fi
  fi
 fi
fi

if [[ ! -O "$PW_FLAG" && $PW -lt 10 ]]; then
 xset dpms force on 2>/dev/null
 MSG=$(cat << EOF
Battery charge level critical (${PW}%)!
Do something about it NOW or touch $PW_FLAG
EOF
)
 DISPLAY=:0 notify-send -u critical -i nwn "Low power alert" "$MSG"
fi

exit 0
